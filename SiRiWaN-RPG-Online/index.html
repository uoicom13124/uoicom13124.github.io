<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<title>SiRiWaN-RPG-Online</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: #111;
    overflow: hidden;
    width: 100vw;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* กรอบเกมหลัก */
  #game-viewport {
    position: relative;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    background: #222;
  }

  /* แผนที่ที่จะเคลื่อนที่ */
  #map-container {
    position: absolute;
    top: 0;
    left: 0;
    will-change: transform;
    image-rendering: pixelated;
  }

  .tile {
    position: absolute;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 0.1px solid rgba(0,0,0,0.05);
  }

  /* ตัวละครถูกล็อคไว้กึ่งกลางหน้าจอเสมอ */
  #character-anchor {
    position: absolute;
    top: 50%;
    left: 50%;
    z-index: 100;
    pointer-events: none;
    transform: translate(-50%, -50%);
  }

  .char-visuals {
    position: relative;
    width: 40px;
    height: 48px;
    transform: translateY(-15px); /* ปรับให้เท้าอยู่ตรงจุดศูนย์กลาง */
  }

  .char-shadow {
    position: absolute;
    bottom: -2px;
    left: 50%;
    transform: translateX(-50%);
    width: 20px;
    height: 6px;
    background: rgba(0,0,0,0.4);
    border-radius: 50%;
  }

  .char-body {
    position: absolute;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .char-head {
    width: 22px;
    height: 20px;
    background: #f5c78a;
    border: 2px solid #c8855a;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    z-index: 2;
  }

  .char-eye { width: 3px; height: 4px; background: #2a1a0a; border-radius: 1px; }

  .char-torso {
    width: 20px;
    height: 16px;
    background: #2244bb;
    border: 2px solid #1133aa;
    border-radius: 4px 4px 2px 2px;
    margin-top: -2px;
  }

  .char-legs { display: flex; gap: 2px; margin-top: -2px; }
  .char-leg { width: 8px; height: 10px; background: #112266; border-radius: 0 0 2px 2px; transform-origin: top; }

  /* Animations */
  @keyframes walk-cycle { 0%, 100% { transform: rotate(20deg); } 50% { transform: rotate(-20deg); } }
  @keyframes bob { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }

  .walking .char-leg:nth-child(1) { animation: walk-cycle 0.25s infinite; }
  .walking .char-leg:nth-child(2) { animation: walk-cycle 0.25s infinite reverse; }
  .walking .char-body { animation: bob 0.25s infinite; }
  .face-left .char-body { transform: scaleX(-1); }

  /* D-PAD */
  #controls {
    position: fixed;
    bottom: 30px;
    left: 30px;
    display: grid;
    grid-template-columns: repeat(3, 60px);
    grid-template-rows: repeat(3, 60px);
    gap: 10px;
    z-index: 1000;
  }

  .btn {
    background: rgba(255,255,255,0.2);
    border: 2px solid rgba(255,255,255,0.4);
    border-radius: 15px;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    touch-action: none;
    user-select: none;
    backdrop-filter: blur(5px);
  }

  .btn:active, .btn.active { background: rgba(255,255,255,0.5); transform: scale(0.9); }
  .empty { pointer-events: none; opacity: 0; }

  @media (min-width: 800px) { #controls { bottom: 40px; left: 40px; } }
</style>
</head>
<body>

<div id="game-viewport">
  <div id="map-container"></div>
  
  <div id="character-anchor">
    <div id="char-sprite" class="char-visuals">
      <div class="char-shadow"></div>
      <div class="char-body">
        <div class="char-head">
          <div class="char-eye"></div>
          <div class="char-eye"></div>
        </div>
        <div class="char-torso"></div>
        <div class="char-legs">
          <div class="char-leg"></div>
          <div class="char-leg"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="controls">
  <div class="empty"></div>
  <div class="btn" id="up">▲</div>
  <div class="empty"></div>
  <div class="btn" id="left">◀</div>
  <div class="btn" id="down">▼</div>
  <div class="btn" id="right">▶</div>
</div>

<script>
const TILE_SIZE = 64;
const MOVE_SPEED = 5; // ความเร็วในการเคลื่อนที่ (tiles ต่อวินาที)

const TILE_TYPES = {
  '.': { name: 'grass', color: '#4CAF50', walkable: true },
  '#': { name: 'wall', color: '#444', walkable: false },
  '~': { name: 'water', color: '#2196F3', walkable: false },
  'P': { name: 'path', color: '#8D6E63', walkable: true }
};

const MAP_DATA = [
  "##########",
  "#........#",
  "#..P..#..#",
  "#.PPP.#..#",
  "#..P..#..#",
  "#..P..#..#",
  "#..PPPP..#",
  "#..#..#..#",
  "#........#",
  "##########"
];

// สถานะเกม
const state = {
  px: 2, // ตำแหน่ง X ของผู้เล่น (ในหน่วย Tile)
  py: 2, // ตำแหน่ง Y ของผู้เล่น
  tx: 2, // เป้าหมาย X
  ty: 2, // เป้าหมาย Y
  isMoving: false,
  progress: 0,
  facing: 'down',
  keys: {},
  mobileDir: null
};

const mapContainer = document.getElementById('map-container');
const charSprite = document.getElementById('char-sprite');

function init() {
  // สร้างแผนที่
  MAP_DATA.forEach((row, r) => {
    [...row].forEach((char, c) => {
      const tileDef = TILE_TYPES[char] || TILE_TYPES['.'];
      const el = document.createElement('div');
      el.className = 'tile';
      el.style.width = TILE_SIZE + 'px';
      el.style.height = TILE_SIZE + 'px';
      el.style.left = (c * TILE_SIZE) + 'px';
      el.style.top = (r * TILE_SIZE) + 'px';
      el.style.backgroundColor = tileDef.color;
      mapContainer.appendChild(el);
    });
  });

  // ระบบควบคุม
  window.addEventListener('keydown', e => state.keys[e.key] = true);
  window.addEventListener('keyup', e => delete state.keys[e.key]);

  const setupBtn = (id, dir) => {
    const el = document.getElementById(id);
    const start = (e) => { e.preventDefault(); state.mobileDir = dir; el.classList.add('active'); };
    const end = () => { if(state.mobileDir === dir) state.mobileDir = null; el.classList.remove('active'); };
    el.addEventListener('touchstart', start);
    el.addEventListener('touchend', end);
    el.addEventListener('mousedown', start);
    el.addEventListener('mouseup', end);
  };

  setupBtn('up', 'up');
  setupBtn('down', 'down');
  setupBtn('left', 'left');
  setupBtn('right', 'right');

  requestAnimationFrame(update);
}

function isWalkable(x, y) {
  if (y < 0 || y >= MAP_DATA.length || x < 0 || x >= MAP_DATA[0].length) return false;
  const char = MAP_DATA[y][x];
  return TILE_TYPES[char]?.walkable;
}

function update(ts) {
  if (!state.lastTs) state.lastTs = ts;
  const dt = (ts - state.lastTs) / 1000;
  state.lastTs = ts;

  if (state.isMoving) {
    state.progress += dt * MOVE_SPEED;
    if (state.progress >= 1) {
      state.px = state.tx;
      state.py = state.ty;
      state.isMoving = false;
      state.progress = 0;
    }
  }

  if (!state.isMoving) {
    let dx = 0, dy = 0;
    const dir = state.mobileDir || (state.keys['w'] || state.keys['ArrowUp'] ? 'up' : 
                state.keys['s'] || state.keys['ArrowDown'] ? 'down' :
                state.keys['a'] || state.keys['ArrowLeft'] ? 'left' :
                state.keys['d'] || state.keys['ArrowRight'] ? 'right' : null);

    if (dir) {
      state.facing = dir;
      if (dir === 'up') dy = -1;
      if (dir === 'down') dy = 1;
      if (dir === 'left') dx = -1;
      if (dir === 'right') dx = 1;

      if (isWalkable(state.px + dx, state.py + dy)) {
        state.tx = state.px + dx;
        state.ty = state.py + dy;
        state.isMoving = true;
      }
    }
  }

  // คำนวณตำแหน่งแสดงผล (Interpolation)
  const renderX = state.px + (state.tx - state.px) * state.progress;
  const renderY = state.py + (state.ty - state.py) * state.progress;

  // เลื่อน Map ให้สวนทางกับผู้เล่น (ทำหน้าที่เป็นกล้อง)
  // สูตร: กึ่งกลางหน้าจอ - (ตำแหน่งผู้เล่น * ขนาด Tile) - (ครึ่ง Tile เพื่อให้กึ่งกลางตัวละคร)
  const viewW = window.innerWidth;
  const viewH = window.innerHeight;
  const camX = (viewW / 2) - (renderX * TILE_SIZE) - (TILE_SIZE / 2);
  const camY = (viewH / 2) - (renderY * TILE_SIZE) - (TILE_SIZE / 2);

  mapContainer.style.transform = `translate(${camX}px, ${camY}px)`;
  
  // อัปเดตท่าทางตัวละคร
  charSprite.classList.toggle('walking', state.isMoving);
  charSprite.classList.toggle('face-left', state.facing === 'left');

  requestAnimationFrame(update);
}

init();
</script>
</body>
</html>

