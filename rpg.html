<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Advanced RPG</title>
<style>
  body { margin:0; overflow:hidden; background:#111; }
  canvas { display:block; }
</style>
</head>
<body>

<canvas id="game"></canvas>

<script>
/* ================= CONFIG ================= */
const TILE = 32;
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

canvas.width = innerWidth;
canvas.height = innerHeight;

/* ================= INPUT ================= */
const keys = {};
addEventListener("keydown", e => keys[e.key] = true);
addEventListener("keyup", e => keys[e.key] = false);

/* ================= MAP ================= */
const MAP_W = 200;
const MAP_H = 200;
const map = [];

for (let y=0;y<MAP_H;y++){
  map[y]=[];
  for(let x=0;x<MAP_W;x++){
    map[y][x] = Math.random()<0.15 ? 1 : 0;
  }
}

/* ================= PLAYER ================= */
const player = {
  x: MAP_W*TILE/2,
  y: MAP_H*TILE/2,
  size: 24,
  speed: 3,
  hp: 100,
  atk: 20,
  atkCooldown: 0
};

/* ================= ENEMY ================= */
const enemies = [];
for(let i=0;i<20;i++){
  enemies.push({
    x: Math.random()*MAP_W*TILE,
    y: Math.random()*MAP_H*TILE,
    size: 24,
    speed: 1.5,
    hp: 40
  });
}

/* ================= COLLISION ================= */
function isWall(px,py){
  const tx = Math.floor(px/TILE);
  const ty = Math.floor(py/TILE);
  return map[ty]?.[tx]===1;
}

/* ================= CAMERA ================= */
const camera = {x:0,y:0};

/* ================= UPDATE ================= */
function update(){
  let dx=0, dy=0;
  if(keys["w"]) dy-=player.speed;
  if(keys["s"]) dy+=player.speed;
  if(keys["a"]) dx-=player.speed;
  if(keys["d"]) dx+=player.speed;

  if(!isWall(player.x+dx,player.y)) player.x+=dx;
  if(!isWall(player.x,player.y+dy)) player.y+=dy;

  camera.x = player.x - canvas.width/2;
  camera.y = player.y - canvas.height/2;

  if(player.atkCooldown>0) player.atkCooldown--;

  // ===== enemy AI =====
  enemies.forEach(e=>{
    const dist = Math.hypot(player.x-e.x, player.y-e.y);
    if(dist<300){
      const angle = Math.atan2(player.y-e.y, player.x-e.x);
      e.x += Math.cos(angle)*e.speed;
      e.y += Math.sin(angle)*e.speed;
    }

    // enemy attack
    if(dist<30){
      player.hp -= 0.3;
    }
  });

  // ===== player attack =====
  if(keys[" "] && player.atkCooldown<=0){
    player.atkCooldown=30;
    enemies.forEach(e=>{
      const d=Math.hypot(player.x-e.x, player.y-e.y);
      if(d<50) e.hp-=player.atk;
    });
  }

  // remove dead enemies
  for(let i=enemies.length-1;i>=0;i--){
    if(enemies[i].hp<=0) enemies.splice(i,1);
  }
}

/* ================= DRAW ================= */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // map
  for(let y=0;y<MAP_H;y++){
    for(let x=0;x<MAP_W;x++){
      ctx.fillStyle = map[y][x] ? "#444":"#2ecc71";
      ctx.fillRect(
        x*TILE-camera.x,
        y*TILE-camera.y,
        TILE,TILE
      );
    }
  }

  // player
  ctx.fillStyle="red";
  ctx.fillRect(
    player.x-camera.x,
    player.y-camera.y,
    player.size,player.size
  );

  // enemies
  enemies.forEach(e=>{
    ctx.fillStyle="purple";
    ctx.fillRect(
      e.x-camera.x,
      e.y-camera.y,
      e.size,e.size
    );
  });

  // UI
  ctx.fillStyle="white";
  ctx.fillText("HP: "+Math.floor(player.hp),20,30);
  ctx.fillText("Enemies: "+enemies.length,20,50);
}

/* ================= LOOP ================= */
function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
